<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us" >

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>Guide to LTO between Rust and C/C&#43;&#43; | Xiangpeng Hao</title>
     <meta property='og:title' content='Guide to LTO between Rust and C/C&#43;&#43; - Xiangpeng Hao'>
<meta property='og:description' content='I use Rust in one of my research projects. The project was originally developed in C&#43;&#43;, and because C&#43;&#43; is bad we decided to add new features primarily in Rust.
Calling Rust from C&#43;&#43; is simple and easy (thanks to the excellent cxx project), but we soon find some performance regressions that didn&rsquo;t appear in the C&#43;&#43; code. Specifically, we see many tiny Rust functions in flamegraph that wouldn&rsquo;t surface up if written in C&#43;&#43;.'>
<meta property='og:url' content='/posts/cross-lang-lto-guide/'>
<meta property='og:site_name' content='Xiangpeng Hao'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2020-10-29T19:23:31&#43;08:00'/><meta property='article:modified_time' content='2020-10-29T19:23:31&#43;08:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="shortcut icon" href="favicon.png" /></head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="/"><h1 class="title is-4">Xiangpeng Hao</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='https://haoxp.xyz' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.042)" stroke-width="4">
        <path fill="currentColor"
            d="M528 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm0 400H48V80h480v352zM208 256c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm-89.6 128h179.2c12.4 0 22.4-8.6 22.4-19.2v-19.2c0-31.8-30.1-57.6-67.2-57.6-10.8 0-18.7 8-44.8 8-26.9 0-33.4-8-44.8-8-37.1 0-67.2 25.8-67.2 57.6v19.2c0 10.6 10 19.2 22.4 19.2zM360 320h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8z">
        </path>
        
    </g>
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/XiangpengHao' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/hao-xiangpeng' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8"
        d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://blog.haoxp.xyz/index.xml' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.045)" stroke-width="40">
        <path
            d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z">
        </path>
    </g>
    
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://t.me/newsathlh' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="m 22.05,1.577 c -0.393,-0.016 -0.784,0.08 -1.117,0.235 -0.484,0.186 -4.92,1.902 -9.41,3.64 C 9.263,6.325 7.005,7.198 5.267,7.867 3.53,8.537 2.222,9.035 2.153,9.059 c -0.46,0.16 -1.082,0.362 -1.61,0.984 -0.79581202,1.058365 0.21077405,1.964825 1.004,2.499 1.76,0.564 3.58,1.102 5.087,1.608 0.556,1.96 1.09,3.927 1.618,5.89 0.174,0.394 0.553,0.54 0.944,0.544 l -0.002,0.02 c 0,0 0.307,0.03 0.606,-0.042 0.3,-0.07 0.677,-0.244 1.02,-0.565 0.377,-0.354 1.4,-1.36 1.98,-1.928 l 4.37,3.226 0.035,0.02 c 0,0 0.484,0.34 1.192,0.388 0.354,0.024 0.82,-0.044 1.22,-0.337 0.403,-0.294 0.67,-0.767 0.795,-1.307 0.374,-1.63 2.853,-13.427 3.276,-15.38 L 23.676,4.725 C 23.972,3.625 23.863,2.617 23.18,2.02 22.838,1.723 22.444,1.593 22.05,1.576 Z" />
    
</svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">October 29, 2020</h2>
    <h1 class="title">Guide to LTO between Rust and C/C&#43;&#43;</h1>
    
    <div class="content">
      

<p>I use Rust in one of my research projects.
The project was originally developed in C++, and because <a href="https://da-data.blogspot.com/2020/10/no-c-still-isnt-cutting-it.html">C++ is bad</a> we decided to add new features primarily in Rust.</p>

<p>Calling Rust from C++ is simple and easy (thanks to the excellent <a href="https://github.com/dtolnay/cxx">cxx</a> project), but we soon find some performance regressions that didn&rsquo;t appear in the C++ code.
Specifically, we see many tiny Rust functions in <a href="https://github.com/flamegraph-rs/flamegraph">flamegraph</a> that wouldn&rsquo;t surface up if written in C++.
The reason is that those Rust functions crossed language boundary and the optimizers have no way to optimize them.</p>

<p>LTO (linking time optimization) can save us because during linking time optimizers can gather enough knowledge about the whole program and (presumably) can find new optimizing opportunities.</p>

<p>I try to enable LTO in my project, but <a href="http://blog.llvm.org/2019/09/closing-gap-cross-language-lto-between.html">it&rsquo;s not easy</a>.
I was in the same situation as those Firefox guys:</p>

<blockquote>
<p>We were beginning to seriously question our understanding of LLVM&rsquo;s inner workings as the problem persisted while we slowly ran out of ideas on how to debug this further.</p>
</blockquote>

<p>I spend about three whole days from zero knowledge on compilers to set up a (hopefully) functional LTO in my real project.
This post is not a step-by-step guide because things change rapidly, but rather it&rsquo;s a list of things we should take care of when incorporating LTO in our projects.
Nevertheless, I have an <a href="https://github.com/XiangpengHao/cxx-cmake-example.git">example GitHub repo</a> which enables cross-language LTO between Rust and C++. If you have any problem building the code, you can check the GitHub action file, which set up the necessary building environment.</p>

<h3 id="rust-llvm-and-c-c-llvm-must-match">Rust LLVM and C/C++ LLVM must match</h3>

<p>The linking time optimizer requires both Rust and C++ to generate understandable bytecode, which means using the same LLVM version.</p>

<p>For this reason, some people suggested to <a href="https://github.com/rust-lang/rust/issues/56371">ship clang</a> as a Rust component.</p>

<p>To check the Rust LLVM version:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; rustc --version --verbose                      
rustc <span style="color:#1c01ce">1</span>.49.0-nightly <span style="color:#000">(</span>ffa2e7ae8 <span style="color:#1c01ce">2020</span>-10-24<span style="color:#000">)</span>
binary: rustc
commit-hash: ffa2e7ae8fbf9badc035740db949b9dae271c29f
commit-date: <span style="color:#1c01ce">2020</span>-10-24
host: x86_64-unknown-linux-gnu
release: <span style="color:#1c01ce">1</span>.49.0-nightly
LLVM version: <span style="color:#1c01ce">11</span>.0</code></pre></div>
<p>To check C/C++ LLVM version:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; clang -v
Ubuntu clang version <span style="color:#1c01ce">11</span>.0.0-2
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/bin
Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/10
Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/9
Found candidate GCC installation: /usr/lib/gcc/x86_64-linux-gnu/10
Found candidate GCC installation: /usr/lib/gcc/x86_64-linux-gnu/9
Selected GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/10
Candidate multilib: .;@m64
Selected multilib: .;@m64</code></pre></div>
<h3 id="install-a-recent-version-of-llvm-toolchain">Install a recent version of LLVM toolchain</h3>

<p>LLVM has good support for Ubuntu/Debian based package manager; you can download the pre-built binary <a href="https://releases.llvm.org/download.html">here</a>.</p>

<p>I&rsquo;m an Arch Linux user and at the time of writing LLVM 11 is <a href="https://www.archlinux.org/todo/llvm-11/">not available</a> on AUR, so I need to compile it from source.</p>

<p>Compile LLVM toolchain is simple and staightforward.
Be sure to select at least <code>clang</code> and <code>lld</code> in cmake parameters.</p>

<p>To build LLVM with LTO support, we also need a linker plugin called <code>LLVMGold</code> (discussed later); we can enable it by specifying <code>-DLLVM_BINUTILS_INCDIR=/path/to/binutils/include</code>, more details <a href="https://llvm.org/docs/GoldPlugin.html#how-to-build-it">here</a>.</p>

<p>Building LLVM can take quite a while (it takes about 5 mins to build and consumes all my 96 CPU cores).</p>

<h3 id="linker-and-linking-plugin">Linker and linking plugin</h3>

<p>&ldquo;LTO support on Linux systems is available via the <a href="https://sourceware.org/binutils/">gold linker</a> which supports LTO via plugins.&rdquo;</p>

<p><code>ld</code> is the GNU linker and <code>lld</code> (or <code>ld.lld</code>) is the LLVM linker; we will stick to LLVM toolchain and use <code>lld</code> for all the linking jobs.</p>

<h3 id="thinlto-and-lto">ThinLTO and LTO</h3>

<p>Covered <a href="https://blog.llvm.org/posts/2016-06-21-thinlto-scalable-and-incremental-lto/">here</a>, in a nutshell, ThinLTO is a new LTO that is faster to compile with similar runtime performance.</p>

<p>Rust supports ThinLTO since <a href="https://github.com/rust-lang/rust/pull/58057">this</a>.</p>

<h3 id="compile-rust-with-thinlto">Compile Rust with ThinLTO</h3>

<p>Covered <a href="https://doc.rust-lang.org/rustc/linker-plugin-lto.html">here</a>, with a few <a href="https://github.com/rust-lang/rust/issues/60059">caveats</a>, which means that until the issue is addressed, we need to compile with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000">RUSTFLAGS</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;-Clinker=clang-11 Clinker-plugin-lto -Clink-arg=-flto&#34;</span> cargo run --release</code></pre></div>
<p>Or:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000">RUSTFLAGS</span><span style="color:#000">=</span><span style="color:#c41a16">&#34;-Clinker=clang-11 -Clinker-plugin-lto -Clink-arg=-fuse-ld=lld&#34;</span> cargo run --release</code></pre></div>
<h3 id="compile-c-c-with-lto">Compile C/C++ with LTO</h3>

<p>I use CMake and CMake supports LTO by:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#a90d91">include</span>(<span style="color:#c41a16">CheckIPOSupported</span>)<span style="color:#000">
</span><span style="color:#000"></span><span style="color:#a90d91">check_ipo_supported</span>(<span style="color:#c41a16">RESULT</span> <span style="color:#c41a16">supported</span> <span style="color:#c41a16">OUTPUT</span> <span style="color:#c41a16">error</span>)<span style="color:#000">
</span><span style="color:#000"></span><span style="color:#a90d91">if</span>(<span style="color:#c41a16">supported</span>)<span style="color:#000">
</span><span style="color:#000"></span>    <span style="color:#a90d91">message</span>(<span style="color:#c41a16">STATUS</span> <span style="color:#c41a16">&#34;IPO / LTO enabled&#34;</span>)<span style="color:#000">
</span><span style="color:#000"></span>    <span style="color:#a90d91">set</span>(<span style="color:#c41a16">CMAKE_INTERPROCEDURAL_OPTIMIZATION</span> <span style="color:#c41a16">TRUE</span>)<span style="color:#000">
</span><span style="color:#000"></span>    <span style="color:#a90d91">add_link_options</span>(<span style="color:#c41a16">-fuse-ld=lld</span>)<span style="color:#000">
</span><span style="color:#000"></span><span style="color:#a90d91">else</span>()<span style="color:#000">
</span><span style="color:#000"></span>    <span style="color:#a90d91">message</span>(<span style="color:#c41a16">STATUS</span> <span style="color:#c41a16">&#34;IPO / LTO not supported: &lt;${error}&gt;&#34;</span>)<span style="color:#000">
</span><span style="color:#000"></span><span style="color:#a90d91">endif</span>()</code></pre></div>
<p><code>add_link_options(-fuse-ld=lld)</code> instruct CMake to use <code>lld</code> instead of <code>ld</code> (otherwise cmake insists to use <code>ld</code> even if you&rsquo;re using clang)</p>

<h3 id="some-results">Some results</h3>

<p>The full code is <a href="https://github.com/XiangpengHao/cxx-cmake-example/blob/master/main.cpp">here</a>, I basically compared two functions:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#a90d91">int</span> <span style="color:#000">rust_echo</span>(<span style="color:#a90d91">int</span> <span style="color:#000">val</span>);
<span style="color:#177500">// Rust code:
</span><span style="color:#177500">// fn rust_echo(val: i32) -&gt; i32 {
</span><span style="color:#177500">//     val
</span><span style="color:#177500">// }
</span><span style="color:#177500"></span>
<span style="color:#a90d91">int</span> <span style="color:#000">cpp_echo</span>(<span style="color:#a90d91">int</span> <span style="color:#000">val</span>)
{
    <span style="color:#a90d91">return</span> <span style="color:#000">val</span>;
}

<span style="color:#a90d91">int</span> <span style="color:#000">test_rust</span>()
{
    <span style="color:#a90d91">int</span> <span style="color:#000">sum</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
    <span style="color:#a90d91">for</span> (<span style="color:#a90d91">int</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">1000000</span>; <span style="color:#000">i</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>)
    {
        <span style="color:#000">sum</span> <span style="color:#000">+=</span> <span style="color:#000">rust_echo</span>(<span style="color:#000">i</span>);
    }
    <span style="color:#a90d91">return</span> <span style="color:#000">sum</span>;
}

<span style="color:#a90d91">int</span> <span style="color:#000">test_cpp</span>()
{
    <span style="color:#a90d91">int</span> <span style="color:#000">sum</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
    <span style="color:#a90d91">for</span> (<span style="color:#a90d91">int</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#1c01ce">1000000</span>; <span style="color:#000">i</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>)
    {
        <span style="color:#000">sum</span> <span style="color:#000">+=</span> <span style="color:#000">cpp_echo</span>(<span style="color:#000">i</span>);
    }
    <span style="color:#a90d91">return</span> <span style="color:#000">sum</span>;
}
</code></pre></div>
<p><strong>Without</strong> LTO:</p>

<pre><code>Calling rust function, time elapsed: 1176600 ns.
Calling c++ function, time elapsed: 100 ns.
</code></pre>

<p><strong>With</strong> LTO:</p>

<pre><code>Calling rust function, time elapsed: 100 ns.
Calling c++ function, time elapsed: 100 ns.
</code></pre>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://www.haoxp.xyz">Xiangpeng Hao</a> 2020</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66103952-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>
</html>

