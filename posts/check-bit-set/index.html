<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us" >

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>Efficient(correct) way to check a bit value in C/C&#43;&#43;  | Xiangpeng Hao</title>
     <meta property='og:title' content='Efficient(correct) way to check a bit value in C/C&#43;&#43;  - Xiangpeng Hao'>
<meta property='og:description' content='It&rsquo;s very common to manipulate data in the bit granularity in high performance systems, and checking whether a bit equals to 1 is one of the primary operations.
The way I usually do is:
#define CHECK_BIT(var, pos) ((((var) &amp; (1 &lt;&lt; pos)) &gt; 0) ? (1) : (0))  It basically creates a mask and perform an and operation against the variable, it&rsquo;s simple and intuitive enough that I never thought it can be a bottleneck.'>
<meta property='og:url' content='/posts/check-bit-set/'>
<meta property='og:site_name' content='Xiangpeng Hao'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2019-07-23T20:04:48-07:00'/><meta property='article:modified_time' content='2019-07-23T20:04:48-07:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="shortcut icon" href="favicon.png" /></head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="/"><h1 class="title is-4">Xiangpeng Hao</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='https://haoxp.xyz' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.042)" stroke-width="4">
        <path fill="currentColor"
            d="M528 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm0 400H48V80h480v352zM208 256c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm-89.6 128h179.2c12.4 0 22.4-8.6 22.4-19.2v-19.2c0-31.8-30.1-57.6-67.2-57.6-10.8 0-18.7 8-44.8 8-26.9 0-33.4-8-44.8-8-37.1 0-67.2 25.8-67.2 57.6v19.2c0 10.6 10 19.2 22.4 19.2zM360 320h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8z">
        </path>
        
    </g>
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/XiangpengHao' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/hao-xiangpeng' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8"
        d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://blog.haoxp.xyz/index.xml' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.045)" stroke-width="40">
        <path
            d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z">
        </path>
    </g>
    
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://t.me/newsathlh' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="m 22.05,1.577 c -0.393,-0.016 -0.784,0.08 -1.117,0.235 -0.484,0.186 -4.92,1.902 -9.41,3.64 C 9.263,6.325 7.005,7.198 5.267,7.867 3.53,8.537 2.222,9.035 2.153,9.059 c -0.46,0.16 -1.082,0.362 -1.61,0.984 -0.79581202,1.058365 0.21077405,1.964825 1.004,2.499 1.76,0.564 3.58,1.102 5.087,1.608 0.556,1.96 1.09,3.927 1.618,5.89 0.174,0.394 0.553,0.54 0.944,0.544 l -0.002,0.02 c 0,0 0.307,0.03 0.606,-0.042 0.3,-0.07 0.677,-0.244 1.02,-0.565 0.377,-0.354 1.4,-1.36 1.98,-1.928 l 4.37,3.226 0.035,0.02 c 0,0 0.484,0.34 1.192,0.388 0.354,0.024 0.82,-0.044 1.22,-0.337 0.403,-0.294 0.67,-0.767 0.795,-1.307 0.374,-1.63 2.853,-13.427 3.276,-15.38 L 23.676,4.725 C 23.972,3.625 23.863,2.617 23.18,2.02 22.838,1.723 22.444,1.593 22.05,1.576 Z" />
    
</svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">July 23, 2019</h2>
    <h1 class="title">Efficient(correct) way to check a bit value in C/C&#43;&#43; </h1>
    
    <div class="content">
      

<p>It&rsquo;s very common to manipulate data in the bit granularity in high performance systems,
and checking whether a bit equals to 1 is one of the primary operations.</p>

<p>The way I usually do is:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#633820">#define CHECK_BIT(var, pos) ((((var) &amp; (1 &lt;&lt; pos)) &gt; 0) ? (1) : (0))
</span></code></pre></div>
<p>It basically creates a mask and perform an <code>and</code> operation against the variable,
it&rsquo;s simple and intuitive enough that I never thought it can be a bottleneck.</p>

<p><strong>TL;DR, code above is the best possible you can do, so, just trust your compiler.</strong></p>

<p>But today I came across an very interesting x86 intel intrinsic, <code>_bittest</code>, it does <strong>exactly</strong> what <code>CHECK_BIT</code> above does.
But it&rsquo;s only one single instruction, and presumably it can greatly boost the performance, and therefore we can make several paper based on it&hellip;</p>

<p>But wait, let me check its performance first.</p>

<p>The first obstacle is I cannot find such intrinsic using gcc or clang!
MSVC has something very similar, but I&rsquo;m never a fan of it.
So I finally turned to icc (a crappy intel C++ compiler), and as expected, it compiles.</p>

<p>Link to it: <a href="https://godbolt.org/z/YrSffc">https://godbolt.org/z/YrSffc</a></p>

<p>We can interpret the assembly code from two perspectives:</p>

<ol>
<li>The compiler doesn&rsquo;t generate the <code>bt</code> instruction by default.</li>
<li>The <code>_bittest</code> intrinsic (as well as the generated <code>bt</code> instruction) is elegant and concise enough to deliver excellent performance.</li>
</ol>

<p>I&rsquo;m more excited about it and can&rsquo;t wait to create a end-to-end benchmark.</p>

<p>Since I only have <code>gcc</code> and <code>clang</code> installed, I decide to embed assembly code into c++,
the assembly code, however, is extremely simple:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#a90d91">inline</span> <span style="color:#a90d91">bool</span> <span style="color:#000">TestBit</span>(<span style="color:#000">uint64_t</span> <span style="color:#000">array</span>, <span style="color:#000">uint64_t</span> <span style="color:#000">bit</span>) {
  <span style="color:#a90d91">bool</span> <span style="color:#000">flag</span>;
  <span style="color:#a90d91">asm</span>(<span style="color:#c41a16">&#34;bt %2,%1; setb %0&#34;</span> <span style="color:#000">:</span> <span style="color:#c41a16">&#34;=q&#34;</span>(<span style="color:#000">flag</span>) <span style="color:#000">:</span> <span style="color:#c41a16">&#34;r&#34;</span>(<span style="color:#000">array</span>), <span style="color:#c41a16">&#34;r&#34;</span>(<span style="color:#000">bit</span>));
  <span style="color:#a90d91">return</span> <span style="color:#000">flag</span>;
}
</code></pre></div>
<p>Here&rsquo;s the link to mini benchmark: <a href="http://quick-bench.com/sI08zBOSeVmsiYJC7jpl4qSxxcU">http://quick-bench.com/sI08zBOSeVmsiYJC7jpl4qSxxcU</a>,
I added some pragma to generate clean assembly code, and it doesn&rsquo;t impact the performance (trust me).</p>

<p>Sadly and amazingly, the assembly version is actually slightly slower than the naive version.
As a black magic hobbyist, I&rsquo;ve expected lots of mysterious performance fluctuation,
but this one is simple and clear: the naive version consistently and significantly outperforms the assembly version.</p>

<p>So I digged into the whole assembly code, here&rsquo;s what clang generates:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#000">33</span><span style="color:#000">.25</span><span style="color:#000">%</span> <span style="color:#000">bt</span>     <span style="color:#000">%rcx</span>,<span style="color:#000">%rax</span>
<span style="color:#000">6</span><span style="color:#000">.13</span><span style="color:#000">%</span>  <span style="color:#000">setb</span>   <span style="color:#000">%dl</span>
<span style="color:#000">7</span><span style="color:#000">.63</span><span style="color:#000">%</span>  <span style="color:#000">mov</span>    <span style="color:#000">%edx</span>,<span style="color:#1c01ce">0xc</span>(<span style="color:#000">%rsp</span>)
<span style="color:#000">35</span><span style="color:#000">.11</span><span style="color:#000">%</span> <span style="color:#000">add</span>    <span style="color:#000">$0x1</span>,<span style="color:#000">%ecx</span>
<span style="color:#000">3</span><span style="color:#000">.05</span><span style="color:#000">%</span>  <span style="color:#000">movzbl</span> <span style="color:#000">%cl</span>,<span style="color:#000">%ecx</span>
<span style="color:#000">3</span><span style="color:#000">.37</span><span style="color:#000">%</span>  <span style="color:#000">cmp</span>    <span style="color:#000">$0x40</span>,<span style="color:#000">%ecx</span></code></pre></div>
<p>Here&rsquo;s what assembly version generates:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">       <span style="color:#000">bt</span>     <span style="color:#000">%rcx</span>,<span style="color:#000">%rax</span>
       <span style="color:#000">setb</span>   <span style="color:#000">%dl</span>
<span style="color:#000">34</span><span style="color:#000">.20</span><span style="color:#000">%</span> <span style="color:#000">and</span>    <span style="color:#000">$0x1</span>,<span style="color:#000">%dl</span>
<span style="color:#000">0</span><span style="color:#000">.19</span><span style="color:#000">%</span>  <span style="color:#000">movzbl</span> <span style="color:#000">%dl</span>,<span style="color:#000">%edx</span>
<span style="color:#000">32</span><span style="color:#000">.44</span><span style="color:#000">%</span> <span style="color:#000">mov</span>    <span style="color:#000">%edx</span>,<span style="color:#1c01ce">0xc</span>(<span style="color:#000">%rsp</span>)
<span style="color:#000">32</span><span style="color:#000">.66</span><span style="color:#000">%</span> <span style="color:#000">add</span>    <span style="color:#000">$0x1</span>,<span style="color:#000">%rcx</span></code></pre></div>
<p>The biggest difference is the assembly version will generates an extra <code>and $0x1, %dl</code>, which is absolutely unnecessary under this context (but slows down the performance).</p>

<p>So far we draw the conclusions:</p>

<ol>
<li><p>Compiler(s) are more familiar to the ISA than (most of) you do.</p></li>

<li><p>Mixing assembly code with C++ might degrade the performance, as it might break the patterns that optimizers trying hard to find.</p></li>
</ol>

<h4 id="closing-words">Closing words</h4>

<p>Wait, did I say &ldquo;The compiler doesn&rsquo;t generate the <code>bt</code> instruction by default&rdquo;?</p>

<p>Most compilers (icc, gcc, MSVC) don&rsquo;t, but clang do.</p>

<p>You can select gcc in the mini benchmark to get a reversed benchmark result :)</p>

<p>{{ template &ldquo;_internal/disqus.html&rdquo; . }}</p>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://www.haoxp.xyz">Xiangpeng Hao</a> 2020</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66103952-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>
</html>

