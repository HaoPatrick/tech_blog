<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us" >

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>A Guide to Locate Linux Kernel Bugs | Xiangpeng Hao</title>
     <meta property='og:title' content='A Guide to Locate Linux Kernel Bugs - Xiangpeng Hao'>
<meta property='og:description' content='Recently we encountered yet another kernel bug: our data structure performs 3-4x slower on kernel v5.2 than on kernel v5.5.x
So I tried to figure out exactly which commit caused the bug, and which commit fixed it. This is a very long journey, and it is extremely difficult for non-kernel developers to work on it.
I found these experiences/lessons to be useful, hope they are helpful to you as well.'>
<meta property='og:url' content='/posts/kernel-bug-guide/'>
<meta property='og:site_name' content='Xiangpeng Hao'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2020-02-19T12:40:12-08:00'/><meta property='article:modified_time' content='2020-02-19T12:40:12-08:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="shortcut icon" href="favicon.png" /></head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="/"><h1 class="title is-4">Xiangpeng Hao</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='https://haoxp.xyz' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.042)" stroke-width="4">
        <path fill="currentColor"
            d="M528 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm0 400H48V80h480v352zM208 256c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm-89.6 128h179.2c12.4 0 22.4-8.6 22.4-19.2v-19.2c0-31.8-30.1-57.6-67.2-57.6-10.8 0-18.7 8-44.8 8-26.9 0-33.4-8-44.8-8-37.1 0-67.2 25.8-67.2 57.6v19.2c0 10.6 10 19.2 22.4 19.2zM360 320h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8z">
        </path>
        
    </g>
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/XiangpengHao' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/hao-xiangpeng' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8"
        d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z" />
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://blog.haoxp.xyz/index.xml' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <g transform="scale(0.045)" stroke-width="40">
        <path
            d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z">
        </path>
    </g>
    
    
</svg></i>
            </span>
          </a><a class="level-item" href='https://t.me/newsathlh' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path
        d="m 22.05,1.577 c -0.393,-0.016 -0.784,0.08 -1.117,0.235 -0.484,0.186 -4.92,1.902 -9.41,3.64 C 9.263,6.325 7.005,7.198 5.267,7.867 3.53,8.537 2.222,9.035 2.153,9.059 c -0.46,0.16 -1.082,0.362 -1.61,0.984 -0.79581202,1.058365 0.21077405,1.964825 1.004,2.499 1.76,0.564 3.58,1.102 5.087,1.608 0.556,1.96 1.09,3.927 1.618,5.89 0.174,0.394 0.553,0.54 0.944,0.544 l -0.002,0.02 c 0,0 0.307,0.03 0.606,-0.042 0.3,-0.07 0.677,-0.244 1.02,-0.565 0.377,-0.354 1.4,-1.36 1.98,-1.928 l 4.37,3.226 0.035,0.02 c 0,0 0.484,0.34 1.192,0.388 0.354,0.024 0.82,-0.044 1.22,-0.337 0.403,-0.294 0.67,-0.767 0.795,-1.307 0.374,-1.63 2.853,-13.427 3.276,-15.38 L 23.676,4.725 C 23.972,3.625 23.863,2.617 23.18,2.02 22.838,1.723 22.444,1.593 22.05,1.576 Z" />
    
</svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">February 19, 2020</h2>
    <h1 class="title">A Guide to Locate Linux Kernel Bugs</h1>
    
    <div class="content">
      

<p>Recently we encountered yet another kernel bug: our data structure performs 3-4x slower on kernel v5.2 than on kernel v5.5.x</p>

<p>So I tried to figure out exactly which commit caused the bug, and which commit fixed it.
This is a very long journey, and it is extremely difficult for non-kernel developers to work on it.</p>

<p>I found these experiences/lessons to be useful, hope they are helpful to you as well.</p>

<h3 id="step-one-find-the-correct-kernel-version">Step one: find the correct kernel version</h3>

<p>Modern linux kernel version obeys the following convention<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>:</p>

<pre><code>    (Kernel Version).(Major Revision).(Minor Revision) - (Patch)
</code></pre>

<p>For example, kernel <code>4.19.84-microsoft-standard</code> means this kernel stems from the 19th major version of v4.x,
it has 84 minor revision and it&rsquo;s patched by microsoft.
Different linux distributions may have different patch convention, for example, kernel on arch linux may look like
<code>5.5.4-arch1-1</code></p>

<p>Most linux minor revisions are rebased from upstream changes, this means that code changes from <code>v5.2.x</code> are actually from, for example, <code>v5.3</code>.</p>

<p>Given what we have discussed, to narrow down the problem space, we need to find a minor revision that fix the bug.
This involves switching between different kernel versions, which is scary and error-prone.
Luckily there&rsquo;s a package called <code>downgrade</code> (arch linux only<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>) that can help.</p>

<p>Through interactive interface, the downgrade allows users to easily switch between the package versions, this of course include the package <code>linux</code>.</p>

<pre><code>sudo downgrade linux
</code></pre>

<p>That&rsquo;s it!</p>

<h3 id="step-two-read-the-changelog">Step two: read the changelog</h3>

<p>After several <strong>reboots</strong>, we can successfully locate a specific kernel version, say, v5.3.8, that fixed the bug.
But we want to know exactly which commit caused the bug.</p>

<p>Unfortunately I didn&rsquo;t have anything better than reading the changelog and guessing the bug.</p>

<p>The kernel changelog can be found here: <a href="https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.3.8">https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.3.8</a>
The changelog of minor revision is usually within 200 commits, so it&rsquo;s relatively easy to go through each commit and filter them by their commit message.</p>

<p>In my case, I know the commit should be related to memory systems, so I searched <code>memory</code>, <code>fault</code>, <code>dax</code>, and find three candidates.
Then I dig into the related discussions and find one commit that is particularly related to my case.</p>

<p>The commit message says this commit fixed a bug introduced by another commit.</p>

<p>To verify this, we&rsquo;ll need to find a kernel version that happens exactly before that bug.</p>

<h3 id="step-three-find-a-kernel-version-containing-a-commit">Step three: find a kernel version containing a commit</h3>

<p>The job is simple: given a commit hash, find a kernel version that containing the commit.</p>

<p>Usually GitHub has this handy function:
<img src="/img/linux-gh.png" alt="" /></p>

<p>But as you might have noticed, the linux repo on github <strong>DO NOT tag minor revisions</strong>, it only has release candidates (rc).
This confuses me a lot, and I ended up cloning the whole linux repo from kernel.org.
Luckily the git repo from kernel.org does have minor revision tags.</p>

<p>We can then find the related tags by:</p>

<pre><code>git tags --contains 23c84eb7837514e16d79ed6d849b13745e0ce688
</code></pre>

<p>It will list all the linux kernel containing that commit.</p>

<p>Unfortunately, this still does not work. Because as I said, code changes to minor revisions are typically rebased from upstream changes.
Querying the upstream commit hash will only show the upstream kernel versions, this means that we cannot find the all the kernel versions containing the changes, because there&rsquo;re multiple equivalent commits (due to merge and rebase).</p>

<p>I don&rsquo;t have any better ways to find equivalent commits, so I decided to research the commit in the changelog.
The following screenshot shows the equivalent commit of <code>23c84</code> is <code>111b0</code>.
<img src="/img/changelog-linux.png" alt="" /></p>

<pre><code>git tag --contains 111b055e43cbca1761eaea0812e35dea556cb8d5
v5.2.10
v5.2.11
v5.2.12
v5.2.13
v5.2.14
v5.2.15
v5.2.16
v5.2.17
v5.2.18
v5.2.19
v5.2.20
v5.2.21
v5.2.3
v5.2.4
v5.2.5
v5.2.6
v5.2.7
v5.2.8
v5.2.9
</code></pre>

<p>From the command above, we know this commit first comes in v5.2.3</p>

<p>Switching between v5.2.3 and v5.2.2 confirmed that this commit did introduce the bug I was expecting.</p>

<p>Great!</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://askubuntu.com/questions/843197/what-are-kernel-version-number-components-w-x-yy-zzz-called/843198#843198">https://askubuntu.com/questions/843197/what-are-kernel-version-number-components-w-x-yy-zzz-called/843198#843198</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2"><a href="https://github.com/pbrisbin/downgrade">https://github.com/pbrisbin/downgrade</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://www.haoxp.xyz">Xiangpeng Hao</a> 2020</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66103952-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>
</html>

